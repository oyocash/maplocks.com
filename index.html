<html>
    <head>
        <title>Maplocks.com - real world locks</title>
        <meta name="description" content="BSV locks in the real world. Locks bitcoins on the Earths's map.">
        <meta name=”robots” content="index, follow">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta charset="UTF-8">
        <meta property="og:title" content="Maplocks.com - real world locks">
        <meta property="og:image" content="/assets/marker-icon-2x-bit-1.png">

        <link rel="apple-touch-icon" sizes="180x180" href="/assets/apple-touch-icon.png">
        <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon-16x16.png">
        <link rel="manifest" href="/assets/site.webmanifest">

        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
        <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
        <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
        <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.min.js"></script>
        <script src="/scripts/rbush.js"></script>
        <script src="/scripts/Leaflet.LayerGroup.Collision.js"></script>

        <link rel="stylesheet" href="/styles/L.Control.Sidebar.css" />
        <script src="/scripts/L.Control.Sidebar.js"></script>

        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-easybutton@2/src/easy-button.css">
        <script src="https://cdn.jsdelivr.net/npm/leaflet-easybutton@2/src/easy-button.js"></script>

        <script src="/scripts/leaflet-color-markers.js"></script>
        <link href="/styles/shuallet.css" rel="stylesheet" type="text/css">
        <script src="/scripts/bsv.browser.min.js"></script>
        <script src="/scripts/api.js"></script>
        <script src="/scripts/params.js"></script>
        <script src="/scripts/bSocial.js"></script>
        <script src="/scripts/bSocialPost.js"></script>
        <script src="/scripts/bSocialLike.js"></script>
        <script src="/scripts/bHelpers.js"></script>
        <script src="/scripts/helpers.js"></script>
        <script src="/scripts/bsv-lock.js"></script>
        <script src="/scripts/idb.js"></script>

        <script src="//cdn.quilljs.com/1.3.6/quill.min.js"></script>
        <link href="//cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
        <script src="https://unpkg.com/quill-image-compress@1.2.11/dist/quill.imageCompressor.min.js"></script>
        <script src="/scripts/purify.min.js"></script>

        <style type="text/css">
            @font-face { font-family: RobotoFlex; src: url('RobotoFlex-Regular.ttf'); }
            html, body {
              height: 100%;
              margin: 0;
              padding: 0;
            }
            #map { height: 100%; }
            #walletButton {
              position: absolute;
              top: 30px;
              right: 10px;
              padding: 10px;
              z-index: 400;
            }
            .leaflet-container a.woc-icon {
                position: absolute;
                top: 0px;
                left: 0px;
                padding-top:5px;
                border: none;
                text-align: center;
                width: 36px;
                height: 36px;
                font: 24px/36px Tahoma, Verdana, sans-serif;
                color: #757575;
                text-decoration: none;
                background: transparent;
            }
            .leaflet-container a.share-icon {
                position: absolute;
                top: 0px;
                left:36px;
                padding-top:5px;
                border: none;
                text-align: center;
                width: 36px;
                height: 36px;
                font: 24px/36px Tahoma, Verdana, sans-serif;
                color: #757575;
                text-decoration: none;
                background: transparent;
            }
            .transparent-tooltip {
              -webkit-text-stroke: 0.4px white; /* width and color */
              color: #a00;
              font-size: 14px;
              font-weight: 900;
              background: transparent;
              border: none;
              box-shadow: none;
              text-align: center;
            }
            .transparent-tooltip::before {
              border: none;
            }
            .tooltip-title {
                font-family: RobotoFlex;
                font-size: 16px;
                font-weight: 500;
                line-height: 32px;
                text-align: center;
                font-family: RobotoFlex;
                padding:10px, 10px;
                border-top-left-radius: 12px;
                border-top-right-radius: 12px;
            }
            .tooltip-content {
                color: rgb(107, 114, 128);
                font-family: RobotoFlex;
                font-size: 16px;
                font-weight: 500;
                line-height: 22px;
                text-align: center;
                vertical-align: middle;
                margin:10px 0px;
            }
            .tooltip-bigContent {
                text-align: left;
            }
            .tooltip-bigContent img {
                width: 100%;
            }
            .coinIcon {
                color: rgb(255, 138, 76);
                font-size: 14px;
                height: 16px;
                line-height: 22px;
                margin-left: 4px;
                vertical-align: middle;
                width: 14px;
                margin-bottom: 2px;
            }
            .popupForm {
                text-align: center;
            }
            .popupForm table {
            }
            .popupForm th {
                font-family: RobotoFlex;
                font-size: 16px;
                font-weight: 500;
                line-height: 22px;
                margin:5px;
            }
            .popupForm td {
                font-family: RobotoFlex;
                font-size: 16px;
                font-weight: 400;
                line-height: 22px;
                margin:5px;
            }
            .popupForm input {
                border-radius: 12px;
                border: 1px solid rgb(209, 213, 219);
                background: rgb(249, 250, 251);
                padding: 10px; 
                width: 100px;
                height: 25px;
                font-family: RobotoFlex;
                font-size: 16px;
                color: rgb(17, 24, 39);
            }
            .popupForm input.long {
                width:95%;
            }
            .popupForm select {
                border-radius: 12px;
                border: 1px solid rgb(209, 213, 219);
                background: rgb(249, 250, 251);
                padding: 3px; 
                font-family: RobotoFlex;
                font-size: 16px;
                color: rgb(17, 24, 39);
            }
            .popupForm textarea {
                border-radius: 12px;
                border: 1px solid rgb(209, 213, 219);
                background: rgb(249, 250, 251);
                padding: 10px; 
                width: 95%;
                height: 150px;
                font-family: RobotoFlex;
                font-size: 16px;
                color: rgb(17, 24, 39);
            }
            .popupForm button {
                background-color: rgba(0, 0, 0, 0);
                background-image: linear-gradient(to right bottom, rgb(253, 186, 140), rgb(208, 56, 1));
                border: 1px solid #fff;
                border-radius: 12px;
                color: rgb(255, 255, 255);
                cursor:pointer;
                font-family: RobotoFlex;
                font-size: 16px;
                font-weight: 500;
                line-height: 22px;
                margin-top: 5px;
                padding: 8px 16px;
            }
            .popupForm #toolbar-container {
                border-top-left-radius: 12px;
                border-top-right-radius: 12px;
            }
            .popupForm #editor-container {
                width:100%;
                height:60%;
                border-bottom-left-radius: 12px;
                border-bottom-right-radius: 12px;
                border: 1px solid rgb(209, 213, 219);
                background: rgb(249, 250, 251);
                padding: 10px;
                font-family: RobotoFlex;
                font-size: 16px;
                color: rgb(17, 24, 39);
            }
            .align-right {
                text-align: right;
                margin-right:0px;
            }
            .popupForm a {
                color: #757575;
            }
            .tabs {
                text-align: left;
            }
            .locationTab {
                margin: 10px;
            }
            .locationTabActive {
                text-decoration: underline;
            }
            .locationTab a {
                font-size: 17px;
                font-weight: bold;
            }
            #markerComments {
                display: none;
            }
            .commentItem {
                border: 1px solid rgb(209, 213, 219);
                border-radius: 8px;
                margin-top:8px;
            }
            .commentItem .top {
                color: #000;
                display: flex;
                font-family: RobotoFlex;
                justify-content: space-between;
                line-height: 24px;
                padding-bottom: 4px;
                padding-left: 8px;
                padding-right: 8px;
                padding-top: 12px
            }
            .commentItem .address {
                color: #000;
                display: block;
                font-family: RobotoFlex;
                font-weight: 600;
                line-height: 20px;
                overflow: hidden;
                text-overflow: ellipsis;
                width: 35%;
            }
            .commentItem .address a {
                color: #000;
                text-decoration: underline;
            }
            .commentItem .timestamp {
                color: rgb(75, 85, 99);
                display: block;
                font-family: RobotoFlex;
                font-size: 14px;
                line-height: 20px;
                padding-left: 8px;
            }
            .commentItem .comment {
                color: rgb(0, 0, 0);
                font-family: RobotoFlex;
                line-height: 24px;
                margin-left: 8px;
                margin-bottom: 5px;
                overflow-x: auto;
                overflow-y: auto;
                padding-bottom: 0px;
                padding-left: 12px;
                padding-right: 12px;
                max-height: 200px;
                text-align: left;
            }
            .commentItem .buttons {
                line-height: 24px;
                margin-left: 8px;
                margin-bottom: 5px;
                padding-bottom: 0px;
                padding-left: 12px;
                padding-right: 12px;
                text-align: left;
            }
            .commentItem .commentButton {
                vertical-align: bottom;
            }
            .commentItem .buttons a {
                color: #757575;
            }
            .likeCommentForm {
                display: none;
            }
            img.leaflet_button {
                text-align: center;
                width: 22px;
                height: 22px;
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                margin-left: 1px;
            }
            a {
                cursor:pointer;
            }
        </style>

        <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
        <meta http-equiv="Pragma" content="no-cache" />
        <meta http-equiv="Expires" content="0" />
    </head>
    <body>
    <div id="mainContainer">
      <div id="mapDiv">
        <div id="map"></div>
        <button class="btn shuallet" id="walletButton" onclick="location.href='/wallet/';">
            <img src="/assets/shuacoin.png" class="shuapng">
            <span class="btn-text">SHUAllet</span>
        </button>
      </div>
      <div id="bars"></div>
      <div id="sidebar"></div>
    </div>
    </body>
</html>

<script src="/scripts/SHUAllet.js"></script>

<script language='javascript'>
    window.dataURL = "https://data.trends.cash:9007/"

    var geoPoints = []
    var localGeoPoints = []
    var comments = [];
    var localComments = {}
    var userMarker;
    var latit = null;
    var longit = null;
    var curNorthEastLat = null
    var curNorthEastLng = null
    var curZoom = null
    var map, markerLayerGroup, collisionLayer, sidebar;

    var getUrlVars = function() {
      var vars = {};
      var parts = window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi, function(m,key,value) {
          vars[key] = value;
      });
      return vars;
    }

    const timeAgo = (date) => {
      const seconds = Math.floor((new Date() - date) / 1000);

      let interval = Math.floor(seconds / 31536000);
      if (interval > 1) {
        return interval + ' years ago';
      }

      interval = Math.floor(seconds / 2592000);
      if (interval > 1) {
        return interval + ' months ago';
      }

      interval = Math.floor(seconds / 86400);
      if (interval > 1) {
        return interval + ' days ago';
      }

      interval = Math.floor(seconds / 3600);
      if (interval > 1) {
        return interval + ' hours ago';
      }

      interval = Math.floor(seconds / 60);
      if (interval > 1) {
        return interval + ' minutes ago';
      }

      if(seconds < 10) return 'just now';

      return Math.floor(seconds) + ' seconds ago';
    };

    const addMarker = (i, addCollision = 1) => {
        var iconStyle;
        if (geoPoints[i].bsv === 0.00000001) iconStyle = bit00000001Icon; else
        if (geoPoints[i].bsv < 0.001) iconStyle = bit0001Icon; else
        if (geoPoints[i].bsv < 0.01) iconStyle = bit001Icon; else
        if (geoPoints[i].bsv < 0.1) iconStyle = bit01Icon; else
        if (geoPoints[i].bsv < 1) iconStyle = bit1Icon; else
        if (geoPoints[i].bsv < 10) iconStyle = bit10Icon; else
        if (geoPoints[i].bsv < 100) iconStyle = bit100Icon; else
        if (geoPoints[i].bsv < 1000) iconStyle = bit1000Icon; else
        if (geoPoints[i].bsv < 100000) iconStyle = bit1000Icon;

        console.log(JSON.stringify(geoPoints[i]))
        if (geoPoints[i].name === null) geoPoints[i].name = ""
        var popupName = geoPoints[i].name.replace(/<[^>]+>/g, '');
        if (popupName.length > 36) {
            popupName = popupName.substring(0, 36);
            popupName = popupName.substring(0, popupName.lastIndexOf(" "))
            popupName = popupName + "..."
        }
        popupName = popupName.replace(/(.{15}[^ ]* )/g, "$1<br />");

        var marker = L.marker(geoPoints[i].coordinates, {icon: iconStyle})
        .bindTooltip(popupName, {permanent: true, direction : 'bottom', className: 'transparent-tooltip', offset: [0, -15]})
        .addTo(markerLayerGroup)
        if (addCollision) {
            collisionLayer.addLayer(marker);
        }
        marker.on("click", async () => {
            showMarkerSidebar(i)
        });

        return marker
    }

    const showMarkerSidebar = async (i) => {
        if (geoPoints[i].name === null) geoPoints[i].name = ""
        var tooltipName = geoPoints[i].name.replace(/<[^>]+>/g, '');
        tooltipName = tooltipName.replace(/(.{23}[^ ]* )/g, "$1<br />");

        var content = `
            <a target="_blank" rel="noopener noreferrer" class="woc-icon" href="https://whatsonchain.com/tx/${geoPoints[i].txid}"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024" class="text-black dark:text-white mt-0 mr-0 w-4 h-4" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M856 376H648V168c0-8.8-7.2-16-16-16H168c-8.8 0-16 7.2-16 16v464c0 8.8 7.2 16 16 16h208v208c0 8.8 7.2 16 16 16h464c8.8 0 16-7.2 16-16V392c0-8.8-7.2-16-16-16zm-480 16v188H220V220h360v156H392c-8.8 0-16 7.2-16 16zm204 52v136H444V444h136zm224 360H444V648h188c8.8 0 16-7.2 16-16V444h156v360z"></path></svg></a>
            <a class="share-icon" onclick="copyLinkToClipboard('${geoPoints[i].txid}')"><svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5 text-black dark:text-white" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M8 9h-1a2 2 0 0 0 -2 2v8a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-8a2 2 0 0 0 -2 -2h-1"></path><path d="M12 14v-11"></path><path d="M9 6l3 -3l3 3"></path></svg></a>

            <div class="tooltip-title">${tooltipName}</div>

            <div class="tooltip-content">[${geoPoints[i].coordinates[0]}, ${geoPoints[i].coordinates[1]}]</div>
            <div class="tooltip-content">locked: <span id="lockedBSVText">${geoPoints[i].bsv}</span><svg stroke="currentColor" fill="currentColor" stroke-width="0" role="img" viewBox="0 0 24 24" class="coinIcon" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><title></title><path d="M14.648 14.423l.003-.004a1.34 1.34 0 0 1-.498.659c-.269.189-.647.338-1.188.364l-1.99.004v-2.93c.288.008 1.565-.013 2.119.015.722.035 1.171.321 1.41.668.262.351.293.82.144 1.224zm-2.129-3.261c.503-.024.852-.162 1.101-.336.214-.146.375-.367.46-.611.134-.375.107-.81-.136-1.135-.223-.319-.638-.584-1.306-.616-.495-.026-1.413-.003-1.664-.01v2.709c.025.004 1.539-.001 1.545-.001zM24 12c0 6.627-5.373 12-12 12S0 18.627 0 12 5.373 0 12 0s12 5.373 12 12zm-6.65 2.142c.022-1.477-1.24-2.332-1.908-2.572.715-.491 1.206-1.043 1.206-2.085 0-1.655-1.646-2.43-2.647-2.529-.082-.009-.31-.013-.31-.013V5.361h-1.633l.004 1.583H10.97V5.367H9.31v1.569c-.292.007-2.049.006-2.049.006v1.401h.571c.601.016.822.362.798.677v6.041a.408.408 0 0 1-.371.391c-.249.011-.621 0-.621 0l-.32 1.588h1.996v1.6h1.661v-1.591h1.091v1.594h1.624v-1.588c1.899.05 3.643-1.071 3.66-2.913z"></path></svg>
            </div>
            <div class="tooltip-content">
                <div class="popupForm">
                    <input id="likeIndex" type="text" name="index" value="${i}" hidden>
                    <input id="likeTxid" type="text" name="txid" value="${geoPoints[i].txid}" hidden>
                    Lock <input id="likeCoins" type="number" name="coins" placeholder="BSV" value="0.01"> BSV for 
                    <select id="likeBlocks" name="blocks" type="number">
                        <option value="6">1 hour</option>
                        <option value="144" >1 day</option>
                        <option value="1008" selected="selected">7 days</option>
                        <option value="10950">30 days</option>
                        <option value="52560">1 year</option>
                        <option value="525600">10 years</option>
                    </select>
                    <button id="lockToPoint" onclick="likeCoordinates(${i})">lock</button>
                </div>

                <div class="tooltip-content tabs">
                    <span class="locationTab locationTabActive" id="overviewTab"><a onclick="showOverview()">Overview</a></span>
                    <span class="locationTab" id="commentsTab"><a onclick="showComments(${i})">Comments</a></span>
                </div>
                <div class="tooltip-bigContent" id="markerOverview"></div>
                <div class="tooltip-bigContent" id="markerComments">
                    <div class="tooltip-content" id="commentFormLink"><a onclick="showCommentForm()">Make a comment</a></div>

                    <div style="display:none" id="commentForm">
                        <input id="commentedTxid" type="text" name="txid" value="${geoPoints[i].txid}" hidden>
                        <div class="tooltip-content popupForm"><textarea id="newCommentContent" placeholder="Make a comment"></textarea></div>

                        <div class="tooltip-content popupForm">
                            Expires in: 
                            <select id="commentLockBlocks" name="blocks" type="number">
                                <option value="6">1 hour</option>
                                <option value="144">1 day</option>
                                <option value="1008">7 days</option>
                                <option value="10950">30 days</option>
                                <option value="52560">1 year</option>
                                <option value="52560000" selected="selected">Never</option>
                            </select> 
                            <span styles="width:50%">&nbsp;</span>
                            <button id="newComment" onclick="addComment(${i})">Comment</button>
                        </div>
                    </div>

                    <div class="tooltip-content" id="commentsList"></div>
                </div>
            </div>
            `

        sidebar.setContent(content);
        sidebar.show();
        populateSidebarContent(i)
    }

    const populateSidebarContent = async (i) => {
        var contentHTML = ""
        if (geoPoints[i].content !== undefined && geoPoints[i].content.length > 0) {
            contentHTML = geoPoints[i].content
        } else {
            const result = await fetch(`${dataURL}getMaplock/${geoPoints[i].txid}`)
            const resultJSON = await result.json()
            if (resultJSON !== undefined && resultJSON.length > 0 && resultJSON[0].content !== undefined) contentHTML = resultJSON[0].content
        }
        contentHTML = DOMPurify.sanitize(contentHTML)
        document.getElementById('markerOverview').innerHTML = contentHTML;
    }
    const showOverview = () => {
        document.getElementById('markerOverview').style.display = 'block';
        document.getElementById('markerComments').style.display = 'none';
        document.getElementById('overviewTab').classList.add('locationTabActive');
        document.getElementById('commentsTab').classList.remove('locationTabActive');
    }
    const showComments = (index) => {
        document.getElementById('markerOverview').style.display = 'none';
        document.getElementById('markerComments').style.display = 'block';
        document.getElementById('overviewTab').classList.remove('locationTabActive');
        document.getElementById('commentsTab').classList.add('locationTabActive');
        getCommentsHTML(index)
    }
    const showCommentForm = () => {
        document.getElementById('commentForm').style.display = 'block';
        document.getElementById('commentFormLink').style.display = 'none';
    }
    const hideCommentForm = () => {
        document.getElementById('commentForm').style.display = 'none';
        document.getElementById('commentFormLink').style.display = 'block';
    }
    const showLikeCommentForm = (index) => {
        document.getElementById('likeCommentForm_' + index).style.display = 'block';
    }
    const hideLikeCommentForm = (index) => {
        document.getElementById('likeCommentForm_' + index).style.display = 'none';
    }

    const pointsToMarkers = async () => {
        markerLayerGroup.clearLayers()
        collisionLayer.clearLayers()
        for (let i = 0; i < geoPoints.length; i++) {
            if (geoPoints[i].satoshis) {
                geoPoints[i].bsv = geoPoints[i].satoshis / 100000000
                geoPoints[i].bsv = parseFloat(geoPoints[i].bsv.toFixed(8));
            }
            if (typeof geoPoints[i].coordinates === 'string' || geoPoints[i].coordinates instanceof String) {
                geoPoints[i].coordinates = JSON.parse(geoPoints[i].coordinates)
            }
            // let selectedMarker = addMarker(i, 0)
            let selectedMarker = addMarker(i)
        }
    }

    const addCoordinates = async() => {
        if (!localStorage.walletAddress) {
            alert("You must have a wallet to add locations")
            window.location.href = '/wallet/';
        }

        const currentHeight = await getBlock();
        let lockHeight = parseInt(currentHeight) + parseInt(document.getElementById('lockBlocks').value);
        let satoshis = 1;
        let content = document.getElementById('newPointCoordinates').value + " " + document.getElementById('newPointName').value + "\n" + document.querySelector(".ql-editor").innerHTML;

        let rawtx = lockPost(localStorage.walletAddress, lockHeight, satoshis, null, content, null);
        if (rawtx) {
            const c = confirm(`Add location "${document.getElementById('newPointCoordinates').value}"?`);
            if (c) {
                rawtx = await payForRawTx(rawtx)
                const t = await broadcast(rawtx, true, localStorage.walletAddress);
                if (t.length === 64) {
                    addTx({'txid': t, 'height': lockHeight, 'satoshis': satoshis})
                    alert(`Maplock added: ${t}`);
                    geoPoints.push({txid: t, name: document.getElementById('newPointName').value, bsv: (satoshis / 100000000), coordinates: JSON.parse(document.getElementById('newPointCoordinates').value)})
                    localGeoPoints.push({txid: t, name: document.getElementById('newPointName').value, content: document.querySelector(".ql-editor").innerHTML, bsv: (satoshis / 100000000), coordinates: JSON.parse(document.getElementById('newPointCoordinates').value)})
                    addMarker(geoPoints.length - 1)
                } else {
                    alert(t)
                }
                sidebar.hide();
            } else { return }
        } 
    }

    const likeCoordinates = async (index) => {
        if (!localStorage.walletAddress) {
            window.location.href = '/profile/';
        }

        const currentHeight = await getBlock();
        const lockHeight = parseInt(currentHeight) + parseInt(document.getElementById(`likeBlocks`).value);
        const lockedBSVs = parseFloat(document.getElementById(`likeCoins`).value)
        let satoshis = parseInt(lockedBSVs * 100000000);
        const txid = document.getElementById(`likeTxid`).value;

        let rawtx = lockLike(localStorage.walletAddress, lockHeight, satoshis, null, txid, null);
        if (rawtx) {
            const c = confirm(`Like ${txid} (${lockedBSVs} BSV for ${lockHeight - currentHeight} blocks)?`);
            if (c) {
                map.closePopup();
                rawtx = await payForRawTx(rawtx)
                const t = await broadcast(rawtx, true, localStorage.walletAddress);
                if (t.length === 64) {
                    addTx({'txid': t, 'height': lockHeight, 'satoshis': satoshis})
                    let localGeoPointsIndex = null;
                    for (let i = 0; i < localGeoPoints.length; i++) {
                        if (localGeoPoints[i].txid === geoPoints[index].txid) {
                            localGeoPointsIndex = i
                            localGeoPoints[i].bsv = parseFloat(localGeoPoints[i].bsv) + parseFloat(lockedBSVs)
                            localGeoPoints[i].bsv = localGeoPoints[i].bsv.toFixed(8);
                            localGeoPoints[i].satoshis += satoshis
                            break
                        }
                    }
                    if (localGeoPointsIndex === null) {
                        geoPoints[index].bsv = parseFloat(geoPoints[index].bsv) + parseFloat(lockedBSVs)
                        geoPoints[index].bsv = geoPoints[index].bsv.toFixed(8);
                        geoPoints[index].satoshis += satoshis
                        localGeoPoints.push(geoPoints[index])
                    }
                    alert(`Maplock liked: ${t}`);
                    addMarker(index, 0)
                } else {
                    alert(t)
                }
            } else { return }
        } 
    }

    const addComment = async (index) => {
        if (!localStorage.walletAddress) {
            alert("You must have a wallet to make comments")
            window.location.href = '/wallet/';
        }

        const currentHeight = await getBlock();
        let repliedTxid = document.getElementById('commentedTxid').value
        let lockHeight = parseInt(currentHeight) + parseInt(document.getElementById('commentLockBlocks').value);
        let satoshis = 1;
        let content = document.getElementById('newCommentContent').value;

        let rawtx = lockPost(localStorage.walletAddress, lockHeight, satoshis, null, content, repliedTxid);
        if (rawtx) {
            const c = confirm(`Add comment "${content}"?`);
            if (c) {
                rawtx = await payForRawTx(rawtx)
                const t = await broadcast(rawtx, true, localStorage.walletAddress);
                if (t.length === 64) {
                    addTx({'txid': t, 'height': lockHeight, 'satoshis': satoshis})
                    alert(`Comment added: ${t}`);
                    if (localComments[repliedTxid] === undefined) localComments[repliedTxid] = [];
                    localComments[repliedTxid].push({txid: t, address: localStorage.walletAddress, content: content, satoshis: satoshis, bsv: (satoshis / 100000000), txTimestamp: (Date.now()/1000)})
                    
                    hideCommentForm();
                    document.getElementById('newCommentContent').value = ""
                    getCommentsHTML(index)
                } else {
                    alert(t)
                }
            } else { return }
        } 
    }

    const likeComment = async (index) => {
        if (!localStorage.walletAddress) {
            window.location.href = '/profile/';
        }

        const currentHeight = await getBlock();
        const lockHeight = parseInt(currentHeight) + parseInt(document.getElementById(`likeCommentBlocks`).value);
        const lockedBSVs = parseFloat(document.getElementById(`likeCommentCoins`).value)
        let satoshis = parseInt(lockedBSVs * 100000000);
        const txid = document.getElementById(`likeCommentTxid`).value;

        let rawtx = lockLike(localStorage.walletAddress, lockHeight, satoshis, null, txid, null);
        if (rawtx) {
            const c = confirm(`Like ${txid} (${lockedBSVs} BSV for ${lockHeight - currentHeight} blocks)?`);
            if (c) {
                hideLikeCommentForm(index);
                rawtx = await payForRawTx(rawtx)
                const t = await broadcast(rawtx, true, localStorage.walletAddress);
                if (t.length === 64) {
                    addTx({'txid': t, 'height': lockHeight, 'satoshis': satoshis});
                    comments[index].bsv = comments[index].bsv + lockedBSVs
                    document.getElementById('likedCommentBSV_' + index).innerHTML = comments[index].bsv;
                } else {
                    alert(t)
                }
            } else { return }
        } 
    }

    const getComments = async (txid, skip) => {
        const r = await fetch(`${dataURL}getPostReplies/`, {
            method: 'post',
            body: JSON.stringify({ txid, skip })
        })
        const res = await r.text();
        console.log(res)
        if (localComments[txid] === undefined) return JSON.parse(res);
        return localComments[txid].concat(JSON.parse(res));
    }

    const getCommentsHTML = async (index) => {
        let commentHTML = ""
        comments = await getComments(geoPoints[index].txid, 0)
        if (comments !== undefined && comments.length > 0) {
            for (let i = 0; i < comments.length; i++) {
                comments[i].bsv = comments[i].satoshis / 100000000
                comments[i].bsv = parseFloat(comments[i].bsv.toFixed(8));

                commentHTML += `<div class="tooltip-content commentItem">
                    <div class="top">
                        <span class="address">${comments[i].address}</span>
                        <span class="timestamp">${timeAgo(comments[i].txTimestamp*1000)}</span>
                    </div>
                    <div class="comment">${comments[i].content.replace(/(?:\r\n|\r|\n)/g, '<br>')}</div>

                    <div class="buttons">
                        <a onclick="showLikeCommentForm(${i})"><svg class="commentButton" stroke="currentColor" fill="none" stroke-linecap="round" stroke-width="1.5px" stroke-linejoin="round" role="img" viewBox="0 0 24 24" height="1.5em" width="1.5em" xmlns="http://www.w3.org/2000/svg" styles="padding-top:5px;"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M12.5 21h-5.5a2 2 0 0 1 -2 -2v-6a2 2 0 0 1 2 -2h10a2 2 0 0 1 1.74 1.012"></path><path d="M11 16a1 1 0 1 0 2 0a1 1 0 0 0 -2 0"></path><path d="M8 11v-4a4 4 0 1 1 8 0v4"></path><path d="M16 19h6"></path><path d="M19 16v6"></path></svg></a>
                        <span id="likedCommentBSV_${i}">${comments[i].bsv}</span><svg stroke="currentColor" fill="currentColor" stroke-width="0" role="img" viewBox="0 0 24 24" class="coinIcon" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><title></title><path d="M14.648 14.423l.003-.004a1.34 1.34 0 0 1-.498.659c-.269.189-.647.338-1.188.364l-1.99.004v-2.93c.288.008 1.565-.013 2.119.015.722.035 1.171.321 1.41.668.262.351.293.82.144 1.224zm-2.129-3.261c.503-.024.852-.162 1.101-.336.214-.146.375-.367.46-.611.134-.375.107-.81-.136-1.135-.223-.319-.638-.584-1.306-.616-.495-.026-1.413-.003-1.664-.01v2.709c.025.004 1.539-.001 1.545-.001zM24 12c0 6.627-5.373 12-12 12S0 18.627 0 12 5.373 0 12 0s12 5.373 12 12zm-6.65 2.142c.022-1.477-1.24-2.332-1.908-2.572.715-.491 1.206-1.043 1.206-2.085 0-1.655-1.646-2.43-2.647-2.529-.082-.009-.31-.013-.31-.013V5.361h-1.633l.004 1.583H10.97V5.367H9.31v1.569c-.292.007-2.049.006-2.049.006v1.401h.571c.601.016.822.362.798.677v6.041a.408.408 0 0 1-.371.391c-.249.011-.621 0-.621 0l-.32 1.588h1.996v1.6h1.661v-1.591h1.091v1.594h1.624v-1.588c1.899.05 3.643-1.071 3.66-2.913z"></path></svg>
                    </div>

                    <div class="popupForm likeCommentForm" id="likeCommentForm_${i}">
                        <input id="likeCommentIndex" type="text" name="index" value="${i}" hidden>
                        <input id="likeCommentTxid" type="text" name="txid" value="${comments[i].txid}" hidden>
                        Lock <input id="likeCommentCoins" type="number" name="coins" placeholder="BSV" value="0.01"> BSV for 
                        <select id="likeCommentBlocks" name="blocks" type="number">
                            <option value="6">1 hour</option>
                            <option value="144" >1 day</option>
                            <option value="1008" selected="selected">7 days</option>
                            <option value="10950">30 days</option>
                            <option value="52560">1 year</option>
                            <option value="525600">10 years</option>
                        </select>
                        <button id="lockToPoint" onclick="likeComment(${i})">lock</button>
                    </div>
                </div>`
            }
        }

        document.getElementById('commentsList').innerHTML = commentHTML;
    }

    const getGeoPoints = async (northEastLat, northEastLng, southWestLat, southWestLng) => {
        const r = await fetch(`${dataURL}getMaplocks/`, {
            method: 'post',
            body: JSON.stringify({ northEastLat, northEastLng, southWestLat, southWestLng })
        })
        const res = await r.text();
        return JSON.parse(res);
    }

    const populatePoints = async () => {
        // get bounds
        var bounds = map.getBounds();
        var northEast = bounds.getNorthEast();
        var southWest = bounds.getSouthWest();
        geoPoints = await getGeoPoints(northEast.lat, northEast.lng, southWest.lat, southWest.lng)
        geoPoints = localGeoPoints.concat(geoPoints)  // add locally stored geo points

        pointsToMarkers()
    }

    const copyLinkToClipboard = (txid) => {
        const link = "https://maplocks.com/?txid=" + txid
        alert(`${link}\n\nCopied`)
        navigator.clipboard.writeText(link);
    }

    const getLocationFromIP = async() => {
        const r = await fetch(`${dataURL}getGeoLocation/`)
        const result = await r.json()
        latit = result.lat
        longit = result.lon
        return
    }
    const getCoords = async () => {
        const pos = await new Promise((resolve, reject) => {
          navigator.geolocation.getCurrentPosition(
            position => resolve(position),
            error => reject(error)
          );
        });

        return {
          long: pos.coords.longitude,
          lat: pos.coords.latitude,
        };
    };
    const addUserMarker = (lat, lng) => {
        if (sidebar.isVisible()) {
            sidebar.hide();
            return
        }
        sidebar.hide();

        if (userMarker) { // check
           map.removeLayer(userMarker); // remove old layers
           userMarker = null;
        } else {
            userMarker = new L.Marker([lat, lng], {icon: bitWhiteIcon}).addTo(map);
            userMarker.bindPopup(`<a onclick="showUserMarkerSidebar(${lat}, ${lng})">Add this location</a>`).openPopup();
        }  
    }
    const showUserMarkerSidebar = async (lat,lng) => {
        var contentUserMarkerTooltip = `<div class="tooltip-title">Add a maplock</div>
            <div class="tooltip-content popupForm"><input type="point" id="newPointCoordinates" class="long" value="[${lat}, ${lng}]"></div>
            <div class="tooltip-content popupForm"><input id="newPointName" class="long" type="name" placeholder="name"></div>
            <div class="tooltip-content popupForm">
                <div id="standalone-container">
                  <div id="toolbar-container">
                    <span class="ql-formats">
                      <button class="ql-bold"></button>
                      <button class="ql-italic"></button>
                      <button class="ql-header" value="1"></button>
                      <button class="ql-header" value="2"></button>
                      <button class="ql-list" value="ordered"></button>
                      <button class="ql-list" value="bullet"></button>
                      <button class="ql-link"></button>
                      <button class="ql-image"></button>
                      <button class="ql-video"></button>
                    </span>
                  </div>
                  <div id="editor-container"></div>
                </div>
            </div>
           
            <div class="tooltip-content popupForm">
                Expires in: 
                <select id="lockBlocks" name="blocks" type="number">
                    <option value="6">1 hour</option>
                    <option value="144">1 day</option>
                    <option value="1008">7 days</option>
                    <option value="10950">30 days</option>
                    <option value="52560">1 year</option>
                    <option value="52560000" selected="selected">Never</option>
                </select> 
                <span styles="width:50%">&nbsp;</span>
                <button id="newPoint" onclick="addCoordinates()">Add</button>
            </div>`


            sidebar.setContent(contentUserMarkerTooltip);
            sidebar.show();

            Quill.register("modules/imageCompressor", imageCompressor);
            var quill = new Quill('#editor-container', {
                modules: {
                  syntax: false,
                  toolbar: '#toolbar-container',
                  imageCompressor: {
                    quality: 0.9,
                    maxWidth: 600, // default
                    maxHeight: 800, // default
                    imageType: 'image/jpeg',
                    keepImageTypes: ['image/jpeg', 'image/png', 'image/gif', 'image/webp', 'image/avif']
                  }
                },
                placeholder: 'Point description',
                theme: 'snow'
            });
    }
    const populateMap = async() => {
        latit = getUrlVars()["latit"]
        longit = getUrlVars()["longit"]

        if (latit === null || latit === undefined || longit === null || longit === undefined) {
            latit = 0; longit = 0;
            if (!getUrlVars()["txid"] || navigator.geolocation) {
                try {
                    position = await getCoords();
                    latit = position.lat
                    longit = position.long
                } catch(err) {}
            }
        }

        map = L.map('map', {
          doubleClickZoom: false
        })
        markerLayerGroup = L.layerGroup().addTo(map);

        map.on('load', async function() {
            populatePoints()
        });

        map.setView([latit, longit], 13); 

        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            minZoom: 2,
            maxZoom: 19,
            attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map);

        // search
        var geocoder = L.Control.geocoder({
          defaultMarkGeocode: false
        })
          .on('markgeocode', function(e) {
            var bbox = e.geocode.bbox;
            var poly = L.polygon([
              bbox.getSouthEast(),
              bbox.getNorthEast(),
              bbox.getNorthWest(),
              bbox.getSouthWest()
            ]).addTo(map);
            map.fitBounds(poly.getBounds());
          })
          .addTo(map);

        // add sibebar  
        sidebar = L.control.sidebar('sidebar', {
            closeButton: true,
            position: 'left'
        });
        map.addControl(sidebar);
        sidebar.hide();

        // add collision layer
        collisionLayer = L.LayerGroup.collision({margin:15});
        collisionLayer.addTo(map);

        // add buttons
        L.easyButton('<img src="/assets/icon-target.svg" class="leaflet_button">', async function(btn, map){
            var position = await getCoords();
            latit = position.lat
            longit = position.long
            map.setView([latit, longit]);
            addUserMarker(latit, longit)
        }).addTo(map);
        if (localStorage.walletAddress) {
            L.easyButton('<img src="/assets/icon-profile-user.svg" class="leaflet_button">', function(btn, map){
                window.location.href='/profile/';
            }).addTo(map);
        }

        sidebar.on('hidden', function () {
            map.removeLayer(userMarker); // remove old layer
        });

        if (!getUrlVars()["txid"] && latit === 0 && longit === 0 && getUrlVars()["latit"] !== 0 && getUrlVars()["longit"] !== 0) {
            try {
                await getLocationFromIP()
                map.panTo(new L.LatLng(latit, longit));
                populatePoints()
            } catch(err) {}
        }

        map.on('moveend', async function(e) {
            var tmpZoom = map.getZoom();
            curZoom = tmpZoom
            setTimeout(function () {
                if (tmpZoom === curZoom) {
                    var bounds = map.getBounds();
                    var northEast = bounds.getNorthEast();
                    if (northEast.lat !== curNorthEastLat && northEast.lng !== curNorthEastLng) {
                        curNorthEastLat = northEast.lat
                        curNorthEastLng = northEast.lng
                        populatePoints()
                    }
                }
            }, 350);
        });
        map.on('click', function (e) {
            addUserMarker(e.latlng.lat, e.latlng.lng)
        });
    }

    (async () => {
        await populateMap()
        if (getUrlVars()["txid"]) {
            const result = await fetch(`${dataURL}getMaplock/${getUrlVars()["txid"]}`)
            const resultJSON = await result.json()
            if (resultJSON !== undefined && resultJSON.length > 0 && resultJSON[0].coordinates !== undefined) {
                geoPoints.push({txid: resultJSON[0].txid, name: resultJSON[0].name, bsv: (resultJSON[0].satoshis / 100000000), coordinates: JSON.parse(resultJSON[0].coordinates)})
                addMarker(geoPoints.length - 1, 0)                
                showMarkerSidebar(geoPoints.length - 1)
                map.panTo(new L.LatLng(JSON.parse(resultJSON[0].coordinates)[0], JSON.parse(resultJSON[0].coordinates)[1]));
                populatePoints();
            } else {
                alert("The location cannot be found")
            }
        }
    })().catch(e => console.log("Caught: " + e)); // Catches it.

    document.addEventListener("DOMContentLoaded", function() {
        if(!localStorage.getItem('disclaimerShown')) {
            alert("Disclaimer\n\nPlease be reminded that we accept no responsibility for any financial losses occurred to users as a result of using this app. Use at your own risk.")
            localStorage.setItem('disclaimerShown', 1)
        }
    })
</script>